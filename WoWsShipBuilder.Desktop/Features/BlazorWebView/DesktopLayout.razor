@using WoWsShipBuilder.Infrastructure.ApplicationTheme
@using WoWsShipBuilder.Features.Settings

@inherits LayoutComponentBase
@implements IDisposable

@inject ThemeManager ThemeManager
@inject AppSettings AppSettings

<MudThemeProvider Theme="@theme" IsDarkMode="isDarkTheme"/>
<MudDialogProvider/>
<MudSnackbarProvider/>

<MudLayout>
    <DesktopTopMenu/>
    <MudMainContent Class="px-2">
        <CascadingValue Name="SettingsInitialized" Value="@settingsInitialized">
            @Body
        </CascadingValue>
    </MudMainContent>
</MudLayout>

@code
{
    private readonly bool settingsInitialized = true;
    private bool isDarkTheme = true;
    private MudTheme theme = default!;

    protected override void OnInitialized()
    {
        base.OnInitialized();
        theme = ThemeManager.AppTheme;
        ThemeManager.ThemeChanged += UpdateTheme;
    }

    private void UpdateTheme(object? sender, MudTheme newTheme)
    {
        theme = newTheme;
        isDarkTheme = AppSettings.ThemeVariant != ThemeManager.ThemeVariant.Light;
        StateHasChanged();
    }

    public void Dispose()
    {
        ThemeManager.ThemeChanged -= UpdateTheme;
    }
}
